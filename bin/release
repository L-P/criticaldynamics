#!/usr/bin/env sh

set -eu

cd "$(dirname "$0")/.."

game="criticaldynamics"
revision="$(git describe)"
dest="$(pwd)/${game}_${revision}.zip"
tmp="$(mktemp -d)/$game"
mkdir -p "$tmp"

__main() {
    git clean -dfX

    bin/buildso
    mkdir -p "$tmp/dlls" "$tmp/cl_dlls"
    cp dlls/*.so "$tmp/dlls/"
    cp cl_dlls/*.so "$tmp/cl_dlls/"

    bin/buildsounds
    rsync -av sound "$tmp/sound"

    bin/buildsprites
    rsync -av sprites "$tmp/sprites"

    make
    mkdir -p "$tmp/wasm" "$tmp/maps"
    cp wasm/*.wasm "$tmp/wasm/"
    cp maps/*.bsp "$tmp/maps/"

    make nodes
    mkdir -p "$tmp/maps/graphs"
    cp maps/graphs/*.nod "$tmp/maps/graphs/"

    __copymisc
    __buildzip

    rm --preserve-root -rf "$(realpath "$tmp/..")"

    echo "Output written to $(realpath --relative-to=. "$dest")"
}

__copymisc() {
    rsync -av resource "$tmp"
    cp titles.txt ./*.fgd ./*.wad logo_big.png liblist.gam game.cfg \
        "$tmp/"
}

__buildzip() {
    (
    cd "$tmp/.."
    rm -f "$dest"
    zip -9 -r "$dest" "$game"
    )
}

__main
