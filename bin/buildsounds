#!/usr/bin/env bash
set -eu

cd "$(dirname "$0")/.."

destdir="sound"
mkdir -p "$destdir"
sentences="$destdir/sentences.txt"

cp "../valve/sound/sentences.txt" "$sentences"
chmod -x "$sentences"
echo "\n// {{{ Generated by bin/buildsounds" >> "$sentences"

readarray a < "soundsrc/sentences.jsonl"

for line in "${a[@]}"; do
    name="$(echo "$line" | jq -r '.[0]')"
    file="generated/"$(echo "$name" | tr '[:upper:]' '[:lower:]')".wav"
    sentence="$(echo "$line" | jq -r '.[1]')"
    noext="${file%.*}"

    destfile="$destdir/$file"
    mkdir -p "$(dirname "$destfile")"
    echo "Generating $name to $destfile"

    # text2wave stdout output is buggy, it mangles the header and adds an
    # extraneous one at the end. We need the tmp buffer.
    echo "$sentence" | text2wave -f 22050 -o tmp.wav

    rm -f "$destfile"
    ffmpeg -loglevel error -i tmp.wav -filter:a "volume=2" -acodec pcm_u8 -ar 22050 -ac 1 "$destfile"
    rm "tmp.wav"
    echo "$name $noext" >> "$sentences"
done

echo '// }}} Generated by bin/buildsounds' >> "$sentences"
