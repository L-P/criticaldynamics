#!/usr/bin/env sh
# This expects the .map to be present in the maps directory and will clean it
# up afterwards. Configure TrenchBroom to export the map to the maps dir first.
set -eux

mod="criticaldynamics"

map="$mod/maps/$1.map"
bsp="$mod/maps/$1.bsp"

(
# Ensure we're in the real HL parent directory for this as compile tools look
# for WADs relative to this path.
cd "$(dirname "$(realpath "$0")")/../.."
rm -f -- "$bsp"

sdHLCSG -cliptype precise "$map"
sdHLBSP "$map"

if [ "${2:=}" = "-fast" ]; then
    sdHLVIS -nofixprt -fast "$map"
    sdHLRAD -fast "$map"
else
    sdHLVIS -nofixprt -full "$map"
    sdHLRAD -bounce 32 "$map"
fi

rm -- "$map"
)
